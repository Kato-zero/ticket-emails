<!DOCTYPE html>
<html>
<head>
  <title>Smart Ticket Generator & Auto-Sender</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdn.emailjs.com/dist/email.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <style>
    body { font-family: Arial; background:#f2f2f2; padding:20px; }
    .container { max-width:450px; margin:auto; background:white; padding:20px; border-radius:12px; box-shadow:0 0 10px rgba(0,0,0,0.1); }
    label { font-size:14px; font-weight:bold; display:block; margin-top:10px; }
    input, textarea { width:100%; padding:8px; margin-top:5px; border:1px solid #ccc; border-radius:6px; }
    button { padding:12px; width:100%; border:none; background:#007bff; color:white; font-size:16px; border-radius:6px; cursor:pointer; margin-top:15px; }
    button:hover { opacity:0.9; }

    /* WhatsApp Button */
    #whatsappBtn {
        background:#25D366;
        font-weight:bold;
    }
  </style>
</head>
<body>

<div class="container">
  <h2>Smart Ticket Generator</h2>

  <label>Paste Spreadsheet Row</label>
  <textarea id="rawText" rows="4" placeholder="Paste your line here..."></textarea>

  <button onclick="parseText()">Auto-Fill</button>

  <label>Event Name</label>
  <input id="eventName" value="Night of Laughter">

  <label>Booking / Ticket ID</label>
  <input id="bookingId">

  <label>Event Date</label>
  <input id="eventDate" value="March 15, 2025">

  <label>Event Time</label>
  <input id="eventTime" value="6:00 PM">

  <label>Venue</label>
  <input id="venue" value="Mulungushi Conference Center">

  <label>Ticket Type</label>
  <input id="ticketType">

  <label>Quantity</label>
  <input id="quantity">

  <label>Customer Name</label>
  <input id="customer">

  <label>Email</label>
  <input id="email">

  <label>Phone</label>
  <input id="phone">

  <label>Payment Date/Time</label>
  <input id="paymentDate">

  <label>Amount Paid (K)</label>
  <input id="amountPaid">

  <label>QR Value (Ticket ID)</label>
  <input id="qrValue">

  <button onclick="generateTicket()">Generate Ticket</button>

  <button id="downloadBtn" style="display:none;" onclick="downloadTicket()">Download Ticket</button>
  <button id="sendBtn" style="display:none;" onclick="sendEmail()">Send via Email</button>
  <button id="whatsappBtn" style="display:none;" onclick="sendWhatsApp()">Send via WhatsApp</button>
</div>

<br>
<div id="ticketArea" style="text-align:center;"></div>

<script>
emailjs.init("bEyhtwp-H-41lvVf1"); // PUBLIC KEY
let finalImageBase64 = "";

/* ---------------- SMART PARSER ----------------- */
function parseText() {
  const text = document.getElementById("rawText").value.trim();
  const parts = text.split(/\t+/);

  if (parts.length < 7) {
    alert("Row format incorrect.");
    return;
  }

  const timestamp = parts[0];
  const name = parts[1];
  const email = parts[2];
  const phone = parts[3];
  const ticketTypeRaw = parts[4];
  const quantity = parts[5];
  const ticketId = parts[6];

  const ticketType = ticketTypeRaw.split("[")[0].trim();

  let amount = "";
  const amountMatch = ticketTypeRaw.match(/\[(.*?)\]/);
  if (amountMatch) amount = amountMatch[1].replace(/[^0-9]/g, "");

  document.getElementById("customer").value = name;
  document.getElementById("email").value = email;
  document.getElementById("phone").value = phone;
  document.getElementById("ticketType").value = ticketType;
  document.getElementById("quantity").value = quantity;
  document.getElementById("bookingId").value = ticketId;
  document.getElementById("qrValue").value = ticketId;
  document.getElementById("amountPaid").value = amount;
  document.getElementById("paymentDate").value = timestamp;
}

/* --------------- GENERATE TICKET ---------------- */
function generateTicket() {
  const html = `
    <div id="ticket" style="
        width: 340px;
        padding: 0;
        background: white;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 0 15px rgba(0,0,0,0.25);
    ">
        <div style="
            background: #111;
            padding: 12px;
            text-align:center;
        ">
            <img src="logo.png" style="width:120px;">
        </div>

        <div style="padding:20px; text-align:center; position:relative;">
            <div style="position:absolute; left:0; top:0; width:10px; height:100%; background:#111;"></div>
            <div style="position:absolute; right:0; top:0; width:10px; height:100%; background:#111;"></div>

            <h2 style="margin-top:0;">Event Ticket</h2>
            <p><strong>Booking ID:</strong> ${bookingId.value}</p>
            <p><strong>Name:</strong> ${customer.value}</p>
            <p><strong>Email:</strong> ${email.value}</p>
            <p><strong>Phone:</strong> ${phone.value}</p>
            <p><strong>Event:</strong> ${eventName.value}</p>
            <p><strong>Date:</strong> ${eventDate.value}</p>
            <p><strong>Time:</strong> ${eventTime.value}</p>
            <p><strong>Venue:</strong> ${venue.value}</p>
            <p><strong>Ticket:</strong> ${ticketType.value} x${quantity.value}</p>
            <p><strong>Paid:</strong> K${amountPaid.value}</p>

            <div id="qrBox" style="margin-top:10px;"></div>
        </div>
    </div>
  `;

  document.getElementById("ticketArea").innerHTML = html;

  const qrBox = document.getElementById("qrBox");
  qrBox.innerHTML = "";
  new QRCode(qrBox, {
    text: document.getElementById("qrValue").value,
    width: 160,
    height: 160
  });

  setTimeout(() => {
    document.getElementById("downloadBtn").style.display = "block";
  }, 500);
}

/* ---------------- DOWNLOAD TICKET ---------------- */
function downloadTicket() {
  html2canvas(document.getElementById("ticket")).then(canvas => {
    const link = document.createElement("a");
    link.download = "ticket.png";
    link.href = canvas.toDataURL();
    link.click();

    finalImageBase64 = canvas.toDataURL("image/png");

    document.getElementById("sendBtn").style.display = "block";
    document.getElementById("whatsappBtn").style.display = "block";
  });
}

/* ---------------- SEND EMAIL ---------------- */
function sendEmail() {
  const params = {
    to_email: document.getElementById("email").value,
    ticket_html: finalImageBase64
  };

  emailjs.send("service_185bxom","template_hff1xll", params)
    .then(() => alert("Email sent!"))
    .catch(e => alert("Email error: " + e));
}

/* ---------------- SEND WHATSAPP ---------------- */
function sendWhatsApp() {
  let phone = document.getElementById("phone").value;
  if (!phone) return alert("Phone number missing!");

  phone = phone.replace(/[^0-9]/g, "");
  if (!phone.startsWith("260")) phone = "260" + phone;

  const msg = `Hello, your ticket is ready.\n\nHere is your ticket image:\n${finalImageBase64}`;

  window.open(`https://wa.me/${phone}?text=${encodeURIComponent(msg)}`, "_blank");
}
</script>

</body>
</html>