<!DOCTYPE html>
<html>
<head>
  <title>Smart Ticket Generator & Auto-Sender</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdn.emailjs.com/dist/email.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <style>
    body { font-family: Arial; background:#f2f2f2; padding:20px; }
    .container { max-width:450px; margin:auto; background:white; padding:20px; border-radius:12px; box-shadow:0 0 10px rgba(0,0,0,0.1); }
    label { font-size:14px; font-weight:bold; display:block; margin-top:10px; }
    input, textarea { width:100%; padding:8px; margin-top:5px; border:1px solid #ccc; border-radius:6px; }
    button { padding:12px; width:100%; border:none; background:#007bff; color:white; font-size:16px; border-radius:6px; cursor:pointer; margin-top:15px; }
    button:hover { opacity:0.9; }

    .ticket { width: 320px; background:white; padding:20px; border-radius:18px; border:1px solid #ccc; margin:auto; font-family: Arial; }
    .title { text-align:center; font-weight:bold; color:#0066cc; font-size:20px; }
    .subtitle { text-align:center; font-size:13px; color:#555; margin-bottom:10px; }
    .line { border-top:1px dashed #aaa; margin:15px 0; }
    .row-label { font-weight:bold; color:#333; }
    .qr-box { text-align:center; background:#f7f7f7; padding:10px; border-radius:12px; margin-top:10px; }
  </style>
</head>
<body>

<div class="container">
  <h2>Smart Ticket Generator</h2>

  <label>Paste Spreadsheet Row (Paragraph)</label>
  <textarea id="rawText" rows="4" placeholder="Paste your line here..."></textarea>

  <button onclick="parseText()">Auto-Fill</button>

  <label>Event Name</label>
  <input id="eventName" value="Night of Laughter">

  <label>Booking / Ticket ID</label>
  <input id="bookingId">

  <label>Event Date</label>
  <input id="eventDate" value="March 15, 2025">

  <label>Event Time</label>
  <input id="eventTime" value="6:00 PM">

  <label>Venue</label>
  <input id="venue" value="Mulungushi Conference Center">

  <label>Ticket Type</label>
  <input id="ticketType">

  <label>Quantity</label>
  <input id="quantity">

  <label>Customer Name</label>
  <input id="customer">

  <label>Email</label>
  <input id="email">

  <label>Phone</label>
  <input id="phone">

  <label>Payment Date + Time</label>
  <input id="paymentDate">

  <label>Amount Paid (K)</label>
  <input id="amountPaid">

  <label>QR Value (usually Ticket ID)</label>
  <input id="qrValue">

  <button onclick="generateAndSend()">Generate & Send Ticket</button>
</div>

<br>
<div id="ticketArea" style="text-align:center;"></div>

<script>
// Initialize EmailJS
emailjs.init("bEyhtwp-H-41lvVf1"); // Your Public Key

/* SMART PARSER */
function parseText() {
  const text = document.getElementById("rawText").value.trim();
  const parts = text.split(/\t+/);

  if (parts.length < 7) {
    alert("This row format is incomplete.");
    return;
  }

  const timestamp     = parts[0];
  const name          = parts[1];
  const email         = parts[2];
  const phone         = parts[3];
  const ticketTypeRaw = parts[4];
  const quantity      = parts[5];
  const ticketId      = parts[6];

  const ticketType = ticketTypeRaw.split("[")[0].trim();

  let amount = "";
  const amountMatch = ticketTypeRaw.match(/\[(.*?)\]/);
  if (amountMatch) amount = amountMatch[1].replace(/[^0-9]/g, "");

  document.getElementById("customer").value = name;
  document.getElementById("email").value = email;
  document.getElementById("phone").value = phone;
  document.getElementById("ticketType").value = ticketType;
  document.getElementById("quantity").value = quantity;
  document.getElementById("bookingId").value = ticketId;
  document.getElementById("qrValue").value = ticketId;
  document.getElementById("amountPaid").value = amount;
  document.getElementById("paymentDate").value = timestamp;
}

/* GENERATE TICKET HTML */
function generateTicketHTML() {
  return `
    <div class="ticket" id="ticket">
      <div class="title">${document.getElementById("eventName").value}</div>
      <div class="subtitle">E-Ticket & Receipt</div>
      <div class="line"></div>

      <p><span class="row-label">Booking ID:</span> ${document.getElementById("bookingId").value}</p>
      <p><span class="row-label">Event:</span> ${document.getElementById("eventName").value}</p>
      <p><span class="row-label">Date:</span> ${document.getElementById("eventDate").value}</p>
      <p><span class="row-label">Time:</span> ${document.getElementById("eventTime").value}</p>
      <p><span class="row-label">Venue:</span> ${document.getElementById("venue").value}</p>

      <p><span class="row-label">Ticket Type:</span> ${document.getElementById("ticketType").value}</p>
      <p><span class="row-label">Quantity:</span> ${document.getElementById("quantity").value}</p>

      <p><span class="row-label">Customer:</span> ${document.getElementById("customer").value}</p>
      <p><span class="row-label">Email:</span> ${document.getElementById("email").value}</p>
      <p><span class="row-label">Phone:</span> ${document.getElementById("phone").value}</p>

      <p><span class="row-label">Payment Date:</span> ${document.getElementById("paymentDate").value}</p>
      <p><span class="row-label">Amount Paid:</span> K${document.getElementById("amountPaid").value}</p>

      <div class="qr-box" id="qrBox"></div>

      <div class="line"></div>
      <p style="text-align:center; font-size:12px;">Present this ticket at the entrance<br>Terms & Conditions apply â€¢ No refunds</p>
    </div>
  `;
}

/* SEND TICKET VIA EMAIL */
function sendTicketEmail(email, ticketDataURL) {
  const templateParams = {
    to_email: email,
    ticket_html: ticketDataURL,
    event_name: document.getElementById("eventName").value,
    booking_id: document.getElementById("bookingId").value,
    event_date: document.getElementById("eventDate").value,
    event_time: document.getElementById("eventTime").value,
    venue: document.getElementById("venue").value,
    ticket_type: document.getElementById("ticketType").value,
    quantity: document.getElementById("quantity").value,
    amount_paid: document.getElementById("amountPaid").value
  };

  emailjs.send("service_185bxom", "template_hff1xll", templateParams)
    .then(() => alert("Ticket sent via email!"))
    .catch(err => console.error("Email send error:", err));
}

/* PLACEHOLDER: SMS */
function sendTicketSMS(phone, ticketLink) {
  console.log(`Send ticket link ${ticketLink} to ${phone} via SMS/WhatsApp`);
}

/* GENERATE AND SEND TICKET */
function generateAndSend() {
  document.getElementById("ticketArea").innerHTML = generateTicketHTML();

  // Generate QR code
  const qrValue = document.getElementById("qrValue").value;
  const qrBox = document.getElementById("qrBox");
  qrBox.innerHTML = "";
  new QRCode(qrBox, {
    text: qrValue,
    width: 180,
    height: 180
  });

  const ticket = document.getElementById("ticket");

  // Wait to ensure QR renders
  setTimeout(() => {
    html2canvas(ticket).then(canvas => {
      const dataURL = canvas.toDataURL(); // PNG

      const email = document.getElementById("email").value;
      sendTicketEmail(email, dataURL);

      const phone = document.getElementById("phone").value;
      sendTicketSMS(phone, dataURL);
    });
  }, 500);
}
</script>

</body>
</html>
